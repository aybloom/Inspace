---
title: "External Data - CrimeRisk"
author: "Amy Youngbloom"
date: "4/8/2022"
output: html_document
---

```{r setup, include=FALSE}
# knit this file with the working directory of "workspace/" instead of "workspace/examples"
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval=FALSE)
knitr::opts_knit$set(root.dir = '~/workspace')
```

## AGS CrimeRisk

Applied Geographic Systems publishes a block-group level dataset of ‘crime risk’.  This pulls from the FBI’s uniform crime reports and 16000 local law enforcement jurisdictions.  We will use area-weighted interpolation of block group-level estimates to construct buffer-specific estimates of the following measures of reported crime:

## Set up ACMT

```{r setup ACMT}
setwd('~/workspace')
source('setup-acmt.R')
```

### 1. import dataset

First, we will import the CrimeRisk dataset (located in the external_data folder)

```{r crimerisk data, warning=FALSE, results='hide'}
setwd('~/workspace/Inspace')
crime_risk_raw<-read.csv('raw_crimerisk.csv')
head(crime_risk_raw)
```

### 2. Process Crime Risk dataset

Next we will write a function to process the crime risk dataset into a 'ACMT-friendly' (long) format. 

```{r process data}

##create a blank function for downloading
download_file_crimerisk<-function(){
}


#run file processing function
process_crimerisk<-function() {
  processed_dataframe<-crime_risk_raw %>%
    rename(total_pop_2022=POPCY) %>% #updated label to reflect that this is the total population based on 2022 census
    dplyr::select(everything(), -COUNTYNAME, -STATENAME)%>%
    melt(id='BLOCKGROUP')%>%
    rename(GEOID=BLOCKGROUP, estimate=value) %>%
    mutate(GEOID=ifelse(GEOID<100000000000, as.character(paste0('0', as.character(GEOID), "")), as.character(GEOID))) #convert to GEOID to character for joining data, need to add an extra 0 in front for some values

processed_dataframe$estimate[is.na(processed_dataframe$estimate)]<-0 #impute NA with 0 values

write.csv(processed_dataframe, 'external_data/processed_crime_risk.csv', quote=TRUE, row.names = FALSE)

}


```


### 3. Designate external dataset settings

Next we need to designate settings for the ACMT, including the vector_of_expected_dowloaded_file_name, the process_fil, the geoid_type, and the variable_name_to_interpolate_by_sum_boolean_mapping

```{r, results='hide'}
setwd('~/workspace')
#set boolean mapping for interpolation
variable_name_to_interpolate_by_sum_boolean_mapping = c(TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE)

names(variable_name_to_interpolate_by_sum_boolean_mapping) = c("total_pop_2022", "CRMCYTOTC","CRMCYPERC","CRMCYMURD","CRMCYRAPE","CRMCYROBB", "CRMCYASST", "CRMCYPROC", "CRMCYBURG",  "CRMCYLARC", "CRMCYMVEH", 'total_pop_2010') 

#designate settings for external data pull
external_data_name_to_info_list <- list(
        crime_risk=list(vector_of_expected_downloaded_file_name=c("~/workspace/Inspace/raw_crimerisk.csv"),
                   download_file=download_file_crimerisk,
                   process_file=process_crimerisk,
                   geoid_type="Block Group",
                   variable_name_to_interpolate_by_sum_boolean_mapping=variable_name_to_interpolate_by_sum_boolean_mapping 
        )
)

```

## 4. Pull in geocded dataset & set up for data pull

Next pull in your geocoded dataset and set it up for pulling the Crime Risk data

```{r import geocoded data}
setwd("/home/rstudio/workspace/Inspace")
dataset_geocode<-read.csv('dataset_geocoded.csv')


## create new dataset column for each variable to be pulled
crime_risk_vars<-c('total_pop_count', 'total_pop_2022', 'CRMCYTOTC', 'CRMCYPERC', 'CRMCYMURD', 'CRMCYRAPE', 'CRMCYROBB', 'CRMCYASST', 'CRMCYPROC', 'CRMCYBURG', 'CRMCYLARC', 'CRMCYMVEH')

#create dataset with a column for each variable at each radius level
var.cols<-data.frame(matrix(nrow=nrow(dataset_geocode), ncol=(length(crime_risk_vars)))) #create dataset of columns
colnames(var.cols)<-crime_risk_vars #name the columns

dataset_crime<-cbind(var.cols, dataset_geocode)

```

## 5. Designate ACMT settings

```{r designate acmt settings, results='hide'}

#Set the list of variable codes, the list of variable names, the radius, and the year for the data you want pulled
codes_of_acs_variables_to_get<-'B01001_001' 
names_of_variables_to_get<-crime_risk_vars
radius_vector <- c(500, 1000, 2000)#set the radius for the area of interest
years <- c(2019) #set the year for the data of interest

```

## 5. Run loop to pull crime data

```{r acmt loop, results='hide'}
setwd('/home/rstudio/workspace/')

#run loop to pull variables
for(radius in 1:length(radius_vector)){
  #radius<-1 #for testing
radius<-radius_vector[radius]
print(radius)
dataset_radius<-dataset_crime

for(address in 1:nrow(dataset_radius)) {
   tryCatch({if(!is.na(dataset_radius[,1][address])) next #skip the row if the data is already there
  if(!is.na(dataset_radius[,1][address])) next #skip the row if the data is already there
  print(address) #print the number to keep track of progress
  latitude<-dataset_radius$lat[address] #set lat
  longitude<-dataset_radius$long[address] #set long
  
  environmental_measures<-get_acmt_standard_array(long=longitude, lat=latitude, radius_meters = radius, year=year, codes_of_acs_variables_to_get = codes_of_acs_variables_to_get, external_data_name_to_info_list=external_data_name_to_info_list, fill_missing_GEOID_with_zero = TRUE) #pull measures for given lat & long
 
      for(name_of_variable in names_of_variables_to_get){ #for each measures, get the value and put it into the column of the same name
     value_of_variable <- environmental_measures[environmental_measures$names == name_of_variable,]$values  
     dataset_radius[[name_of_variable]][address]<-value_of_variable
  }

 for (name_of_variable in names_of_variables_to_get) {
        dataset_radius[[name_of_variable]][address] <- environmental_measures[environmental_measures$names == name_of_variable, ]$values  
 }},error=function(e){cat("ERROR :", conditionMessage(e), "\n")}) #this will print any error messages
}

if(radius==500) {
dataset_crime2<-dataset_radius
dataset_crime2$radius<-500}

if(radius>500){
dataset_radius$radius<-radius
dataset_crime2<-rbind(dataset_crime2, dataset_radius)
}

}
dataset_crime2<-dataset_crime2 %>% 
  mutate(year=year) %>%
  dplyr::select(id, radius, year, everything(), -lat, -long)

head(dataset_crime2)
dataset_crime2$X<-NULL


```
  
## 6. Export final Crime Risk Dataset

```{r export crime data}
setwd('/home/rstudio/workspace/Inspace')

write.csv(dataset_crime2, 'dataset_crimerisk.csv')

```
 
