---
title: "Geocoding - Inspace"
author: "Amy Youngbloom"
date: "7/22/2022"
output: html_document
---

```{r setup, include=FALSE}
#knit this file with the working directory of "workspace/" instead of "workspace/examples"
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval=FALSE)
knitr::opts_knit$set(root.dir = '/home/rstudio/workspace/')
```

```{r load packages & the ACMT}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(janitor)
library(reshape2)
setwd("/home/rstudio/workspace/")
source("GeocoderACMT.R")
```

## Using the ACMT Geocoder

If your data has not yet been geocoded, you can use the ACMT Geocoder to do this step. Before geocoding, run the Mapping addresses & geocodes Code to check geocodes and update addresses as necessary. 

## 1. Import dataset

Once addresses have been updated as much as possible, you can import your data and ensure that the entire address is in one field.

```{r import raw data}
setwd("/home/rstudio/workspace/Inspace")
raw_data<-read.csv('dataset_example.csv')
head(raw_data)
```

If your data has the address field separated into multiple columns (street, city, state, zip), you can combine them with the code below. If the address is already in one field, check that the 'id' is lowercase.  


| id  |  address                              | 
|-----|---------------------------------------|
| 01  | Street, City, State, zipcode          | 



```{r combine address fields}
dataset<-raw_data %>%
  mutate(address=paste(street, city, state, zip, sep=', ')) %>% ##Ensure your dataset has these column names
  dplyr::select(id=ID, address)
head(dataset)
```

## 2. Add lat/long fields to your dataset

* Once we have one address field, we can write a loop that geocodes each address and finds the latitude and longitude for each address point. Those latitude and longitude values are added to the dataset with the following loop code: 

```{r geocode addresses, results='hide'}
#create lat and long columns
dataset_geocode<-dataset %>%
  mutate(lat=NA, 
         long=NA, 
         rating=NA)
```

## 3. Run geocoding loop to geocode all your data

```{r geocode loop, results='hide'}
#Geocoding loop
for (i in 1:nrow(dataset_geocode)) {
  if(!is.na(dataset_geocode$lat[i])) next #skip already geocoded
  if(is.na(dataset_geocode$address[i])) next #skip NA address values
  print(i) #print the number to track progress
  
  address<-dataset_geocode$address
  tryCatch({
  lat_long<-geocode(address[i])},error=function(e){cat("ERROR :", conditionMessage(e), "\n")})
  dataset_geocode$lat[i]<-lat_long$latitude # add latitude to dataset_geocode
  dataset_geocode$long[i] <-lat_long$longitude # add longitude to dataset_geocode
  dataset_geocode$rating[i]<-lat_long$rating # add rating to the dataset_geocode
}

head(dataset_geocode%>%dplyr::select(id, lat, long, rating))
```

Your geocoded dataset should now look as follows: 

| id  |  address                              | lat     |  long     | rating  |
|-----|---------------------------------------|---------|-----------|---------|
| 01  | 3400 Rainier Ave S, Seattle, WA 98144 | 47.57296| -122.2939 | 10      |


Save a file with your ratings -- this will be shared when you share your data. 

## 4. Export your geocoded data. 

It is ready to be used for pulling measures. We will first remove the address column, which we don't need anymore, then export the dataset

```{r data export}
#export rating dataset
write.csv(dataset_geocode%>%dplyr::select(id, rating), 'Inspace/dataset_ratings.csv')
#export lat/long dataset -- this will be used for pulling environmental measures
write.csv(dataset_geocode%>%dplyr::select(id, lat, long), 'Inspace/dataset_geocoded.csv') 
```
